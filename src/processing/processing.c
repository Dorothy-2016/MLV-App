/* Some functions that are used within raw_processing.c
 * This file is directly #included in raw_processing.c */

/* included so idiotic visual studio code shuts up */
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include "processing_object.h"

#ifndef M_E
# define M_E 2.7182818284590452354
#endif

/* Measurements taken from 5D Mark II RAW photos using EXIFtool, surely Canon can't be wrong about WB mutipliers? */
static const int wb_kelvin[]   = {  2000,  2500,  3000,  3506,  4000,  4503,  5011,  5517,  6018,  6509,  7040,  7528,  8056,  8534,  9032,  9531, 10000 };
static const double wb_red[]   = { 1.134, 1.349, 1.596, 1.731, 1.806, 1.954, 2.081, 2.197, 2.291, 2.365, 2.444, 2.485, 2.528, 2.566, 2.612, 2.660, 2.702 };
static const double wb_green[] = { 1.155, 1.137, 1.112, 1.056, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000 };
static const double wb_blue[]  = { 4.587, 3.985, 3.184, 2.524, 2.103, 1.903, 1.760, 1.641, 1.542, 1.476, 1.414, 1.390, 1.363, 1.333, 1.296, 1.263, 1.229 };

static const double id_matrix[] = {1,0,0,0,1,0,0,0,1};

static const double xyz_to_rgb[] = {
    3.240710, -0.9692580,  0.0556352,
   -1.537260,  1.8759900, -0.2039960,
   -0.498571,  0.0415557,  1.0570700
};

/* Cone space! */
static const double ciecam02[] = {
    0.7328,  0.4296, -0.1624,
   -0.7036,  1.6975,  0.0061,
    0.0030,  0.0136,  0.9834
};

/* Tonemapping info from http://filmicworlds.com/blog/filmic-tonemapping-operators/ */

/* Reinhard - most basic but just werks */
double ReinhardTonemap(double x) { return x / (1.0 + x); }
float ReinhardTonemap_f(float x) { return x / (1.0f + x); }

/* Interesting inverse tangent curve */
double TangentTonemap(double x) { return atan(x) / atan(8.0); }
float TangentTonemap_f(float x) { return atanf(x) / atanf(8.0f); }

/* Canon C-Log: http://learn.usa.canon.com/app/pdfs/white_papers/White_Paper_Clog_optoelectronic.pdf (not working right) */
double CanonCLogTonemap(double x) { return (0.529136 * log10(x * 1015.96 + 1.0) + 0.0730597); }
float CanonCLogTonemap_f(float x) { return (0.529136f * log10f(x * 1015.96f + 1.0f) + 0.0730597f); }

/* Calculate Alexa Log curve (iso 800 version), from here: http://www.vocas.nl/webfm_send/964 */
double AlexaLogCTonemap(double x) { return (x > 0.010591) ? (0.247190 * log10(5.555556 * x + 0.052272) + 0.385537) : (5.367655 * x + 0.092809); }
float AlexaLogCTonemap_f(float x) { return (x > 0.010591f) ? (0.247190f * log10f(5.555556f * x + 0.052272f) + 0.385537f) : (5.367655f * x + 0.092809f); }

/* Cineon Log, formula from here: http://www.magiclantern.fm/forum/index.php?topic=15801.msg158145#msg158145 */
double CineonLogTonemap(double x) { return ((log10(x * (1.0 - 0.0108) + 0.0108)) * 300.0 + 685.0) / 1023.0; }
float CineonLogTonemap_f(float x) { return ((log10f(x * (1.0f - 0.0108f) + 0.0108f)) * 300.0f + 685.0f) / 1023.0f; }

/* Sony S-Log3, from here: https://www.sony.de/pro/support/attachment/1237494271390/1237494271406/technical-summary-for-s-gamut3-cine-s-log3-and-s-gamut3-s-log3.pdf */
double SonySLogTonemap(double x) { return (x >= 0.01125000) ? (420.0 + log10((x + 0.01) / (0.18 + 0.01)) * 261.5) / 1023.0 : (x * (171.2102946929 - 95.0) / 0.01125000 + 95.0) / 1023.0; }
float SonySLogTonemap_f(float x) { return (x >= 0.01125000f) ? (420.0f + log10f((x + 0.01f) / (0.18f + 0.01f)) * 261.5f) / 1023.0f : (x * (171.2102946929f - 95.0f) / 0.01125000f + 95.0f) / 1023.0f; }

/* Returns multipliers for white balance by (linearly) interpolating measured 
 * Canon values... stupidly simple, also range limited to 2500-10000 (pls obey) */
void get_kelvin_multipliers_rgb(double kelvin, double * multiplier_output)
{
    kelvin = MIN(MAX(kelvin, 2000.0), 10000.0);
    int k = 0;

    while (1 < 2)
    {
        if ( kelvin > wb_kelvin[k] && kelvin < wb_kelvin[k+1] ) 
        {
            break;
        }

        /* Doesn't need interpolation */
        else if ( kelvin == wb_kelvin[k] )
        {
            multiplier_output[0] = wb_red[k];
            multiplier_output[1] = wb_green[k];
            multiplier_output[2] = wb_blue[k];
            return;
        }

        k++;
    }

    double diff1 = (double)wb_kelvin[k+1] - (double)wb_kelvin[k];
    double diff2 = (double)wb_kelvin[k+1] - kelvin;

    /* Weight between the two */
    double weight1 = diff2 / diff1;
    double weight2 = 1.0 - weight1;

    multiplier_output[0] = (   wb_red[k] * weight1) + (   wb_red[k+1] * weight2);
    multiplier_output[1] = ( wb_green[k] * weight1) + ( wb_green[k+1] * weight2);
    multiplier_output[2] = (  wb_blue[k] * weight1) + (  wb_blue[k+1] * weight2);
}

/* CIE 1931: Wavelengths and their corresponding XYZ values */
long double wavelengths[] = { 360, 365, 370, 375, 380, 385, 390, 395, 400, 405, 410, 415,
    420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480, 485, 490,
    495, 500, 505, 510, 515, 520, 525, 530, 535, 540, 545, 550, 555, 560, 565,
    570, 575, 580, 585, 590, 595, 600, 605, 610, 615, 620, 625, 630, 635, 640,
    645, 650, 655, 660, 665, 670, 675, 680, 685, 690, 695, 700, 705, 710, 715,
    720, 725, 730, 735, 740, 745, 750, 755, 760, 765, 770, 775, 780, 785, 790,
    795, 800, 805, 810, 815, 820, 825, 830 };
long double value_X[] = { 0.0001299, 0.0002321, 0.0004149, 0.0007416, 0.001368, 0.002236,
    0.004243, 0.00765, 0.01431, 0.02319, 0.04351, 0.07763, 0.13438, 0.21477,
    0.2839, 0.3285, 0.34828, 0.34806, 0.3362, 0.3187, 0.2908, 0.2511, 0.19536,
    0.1421, 0.09564, 0.05795001, 0.03201, 0.0147, 0.0049, 0.0024, 0.0093,
    0.0291, 0.06327, 0.1096, 0.1655, 0.2257499, 0.2904, 0.3597, 0.4334499,
    0.5120501, 0.5945, 0.6784, 0.7621, 0.8425, 0.9163, 0.9786, 1.0263, 1.0567,
    1.0622, 1.0456, 1.0026, 0.9384, 0.8544499, 0.7514, 0.6424, 0.5419, 0.4479,
    0.3608, 0.2835, 0.2187, 0.1649, 0.1212, 0.0874, 0.0636, 0.04677, 0.0329,
    0.0227, 0.01584, 0.01135916, 0.008110916, 0.005790346, 0.004106457,
    0.002899327, 0.00204919, 0.001439971, 0.0009999493, 0.0006900786,
    0.0004760213, 0.0003323011, 0.0002348261, 0.0001661505, 0.000117413,
    8.307527E-05, 5.870652E-05, 4.150994E-05, 2.935326E-05, 2.067383E-05,
    1.455977E-05, 1.025398E-05, 7.221456E-06, 5.085868E-06, 3.581652E-06,
    2.522525E-06, 1.776509E-06, 1.251141E-06 };
long double value_Y[] = { 3.917E-06, 6.965E-06, 1.239E-05, 2.202E-05, 3.9E-05, 6.4E-05,
    0.00012, 0.000217, 0.000396, 0.00064, 0.00121, 0.00218, 0.004, 0.0073,
    0.0116, 0.01684, 0.023, 0.0298, 0.038, 0.048, 0.06, 0.0739, 0.09098, 0.1126,
    0.13902, 0.1693, 0.20802, 0.2586, 0.323, 0.4073, 0.503, 0.6082, 0.71,
    0.7932, 0.862, 0.9148501, 0.954, 0.9803, 0.9949501, 1, 0.995, 0.9786, 0.952,
    0.9154, 0.87, 0.8163, 0.757, 0.6949, 0.631, 0.5668, 0.503, 0.4412, 0.381,
    0.321, 0.265, 0.217, 0.175, 0.1382, 0.107, 0.0816, 0.061, 0.04458, 0.032,
    0.0232, 0.017, 0.01192, 0.00821, 0.005723, 0.004102, 0.002929, 0.002091,
    0.001484, 0.001047, 0.00074, 0.00052, 0.0003611, 0.0002492, 0.0001719,
    0.00012, 8.48E-05, 6E-05, 4.24E-05, 3E-05, 2.12E-05, 1.499E-05, 1.06E-05,
    7.4657E-06, 5.2578E-06, 3.7029E-06, 2.6078E-06, 1.8366E-06, 1.2934E-06,
    9.1093E-07, 6.4153E-07, 4.5181E-07 };
long double value_Z[] = { 0.0006061, 0.001086, 0.001946, 0.003486, 0.006450001, 0.01054999,
    0.02005001, 0.03621, 0.06785001, 0.1102, 0.2074, 0.3713, 0.6456, 1.0390501,
    1.3856, 1.62296, 1.74706, 1.7826, 1.77211, 1.7441, 1.6692, 1.5281, 1.28764,
    1.0419, 0.8129501, 0.6162, 0.46518, 0.3533, 0.272, 0.2123, 0.1582, 0.1117,
    0.07824999, 0.05725001, 0.04216, 0.02984, 0.0203, 0.0134, 0.008749999,
    0.005749999, 0.0039, 0.002749999, 0.0021, 0.0018, 0.001650001, 0.0014,
    0.0011, 0.001, 0.0008, 0.0006, 0.00034, 0.00024, 0.00019, 0.0001,
    4.999999E-05, 3E-05, 2E-05, 1E-05, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

/* From http://www.cvrl.org/, 2006 colour matching functions */
// double xyz_match[] = {  390,2.952420E-03,4.076779E-04,1.318752E-02,
//                         395,7.641137E-03,1.078166E-03,3.424588E-02,
//                         400,1.879338E-02,2.589775E-03,8.508254E-02,
//                         405,4.204986E-02,5.474207E-03,1.927065E-01,
//                         410,8.277331E-02,1.041303E-02,3.832822E-01,
//                         415,1.395127E-01,1.712968E-02,6.568187E-01,
//                         420,2.077647E-01,2.576133E-02,9.933444E-01,
//                         425,2.688989E-01,3.529554E-02,1.308674E+00,
//                         430,3.281798E-01,4.698226E-02,1.624940E+00,
//                         435,3.693084E-01,6.047429E-02,1.867751E+00,
//                         440,4.026189E-01,7.468288E-02,2.075946E+00,
//                         445,4.042529E-01,8.820537E-02,2.132574E+00,
//                         450,3.932139E-01,1.039030E-01,2.128264E+00,
//                         455,3.482214E-01,1.195389E-01,1.946651E+00,
//                         460,3.013112E-01,1.414586E-01,1.768440E+00,
//                         465,2.534221E-01,1.701373E-01,1.582342E+00,
//                         470,1.914176E-01,1.999859E-01,1.310576E+00,
//                         475,1.283167E-01,2.312426E-01,1.010952E+00,
//                         480,7.593120E-02,2.682271E-01,7.516389E-01,
//                         485,3.836770E-02,3.109438E-01,5.549619E-01,
//                         490,1.400745E-02,3.554018E-01,3.978114E-01,
//                         495,3.446810E-03,4.148227E-01,2.905816E-01,
//                         500,5.652072E-03,4.780482E-01,2.078158E-01,
//                         505,1.561956E-02,5.491344E-01,1.394643E-01,
//                         510,3.778185E-02,6.248296E-01,8.852389E-02,
//                         515,7.538941E-02,7.012292E-01,5.824484E-02,
//                         520,1.201511E-01,7.788199E-01,3.784916E-02,
//                         525,1.756832E-01,8.376358E-01,2.431375E-02,
//                         530,2.380254E-01,8.829552E-01,1.539505E-02,
//                         535,3.046991E-01,9.233858E-01,9.753000E-03,
//                         540,3.841856E-01,9.665325E-01,6.083223E-03,
//                         545,4.633109E-01,9.886887E-01,3.769336E-03,
//                         550,5.374170E-01,9.907500E-01,2.323578E-03,
//                         555,6.230892E-01,9.997775E-01,1.426627E-03,
//                         560,7.123849E-01,9.944304E-01,8.779264E-04,
//                         565,8.016277E-01,9.848127E-01,5.408385E-04,
//                         570,8.933408E-01,9.640545E-01,3.342429E-04,
//                         575,9.721304E-01,9.286495E-01,2.076129E-04,
//                         580,1.034327E+00,8.775360E-01,1.298230E-04,
//                         585,1.106886E+00,8.370838E-01,8.183954E-05,
//                         590,1.147304E+00,7.869950E-01,5.207245E-05,
//                         595,1.160477E+00,7.272309E-01,3.347499E-05,
//                         600,1.148163E+00,6.629035E-01,2.175998E-05,
//                         605,1.113846E+00,5.970375E-01,1.431231E-05,
//                         610,1.048485E+00,5.282296E-01,9.530130E-06,
//                         615,9.617111E-01,4.601308E-01,6.426776E-06,
//                         620,8.629581E-01,3.950755E-01,0.000000E+00,
//                         625,7.603498E-01,3.351794E-01,0.000000E+00,
//                         630,6.413984E-01,2.751807E-01,0.000000E+00,
//                         635,5.290979E-01,2.219564E-01,0.000000E+00,
//                         640,4.323126E-01,1.776882E-01,0.000000E+00,
//                         645,3.496358E-01,1.410203E-01,0.000000E+00,
//                         650,2.714900E-01,1.083996E-01,0.000000E+00,
//                         655,2.056507E-01,8.137687E-02,0.000000E+00,
//                         660,1.538163E-01,6.033976E-02,0.000000E+00,
//                         665,1.136072E-01,4.425383E-02,0.000000E+00,
//                         670,8.281010E-02,3.211852E-02,0.000000E+00,
//                         675,5.954815E-02,2.302574E-02,0.000000E+00,
//                         680,4.221473E-02,1.628841E-02,0.000000E+00,
//                         685,2.948752E-02,1.136106E-02,0.000000E+00,
//                         690,2.025590E-02,7.797457E-03,0.000000E+00,
//                         695,1.410230E-02,5.425391E-03,0.000000E+00,
//                         700,9.816228E-03,3.776140E-03,0.000000E+00,
//                         705,6.809147E-03,2.619372E-03,0.000000E+00,
//                         710,4.666298E-03,1.795595E-03,0.000000E+00,
//                         715,3.194041E-03,1.229980E-03,0.000000E+00,
//                         720,2.205568E-03,8.499903E-04,0.000000E+00,
//                         725,1.524672E-03,5.881375E-04,0.000000E+00,
//                         730,1.061495E-03,4.098928E-04,0.000000E+00,
//                         735,7.400120E-04,2.860718E-04,0.000000E+00,
//                         740,5.153113E-04,1.994949E-04,0.000000E+00,
//                         745,3.631969E-04,1.408466E-04,0.000000E+00,
//                         750,2.556624E-04,9.931439E-05,0.000000E+00,
//                         755,1.809649E-04,7.041878E-05,0.000000E+00,
//                         760,1.287394E-04,5.018934E-05,0.000000E+00,
//                         765,9.172477E-05,3.582218E-05,0.000000E+00,
//                         770,6.577532E-05,2.573083E-05,0.000000E+00,
//                         775,4.708916E-05,1.845353E-05,0.000000E+00,
//                         780,3.407653E-05,1.337946E-05,0.000000E+00,
//                         785,2.469630E-05,9.715798E-06,0.000000E+00,
//                         790,1.794555E-05,7.074424E-06,0.000000E+00,
//                         795,1.306345E-05,5.160948E-06,0.000000E+00,
//                         800,9.565993E-06,3.788729E-06,0.000000E+00,
//                         805,7.037621E-06,2.794625E-06,0.000000E+00,
//                         810,5.166853E-06,2.057152E-06,0.000000E+00,
//                         815,3.815429E-06,1.523114E-06,0.000000E+00,
//                         820,2.837980E-06,1.135758E-06,0.000000E+00,
//                         825,2.113325E-06,8.476168E-07,0.000000E+00,
//                         830,1.579199E-06,6.345380E-07,0.000000E+00  };

/* From http://www.cvrl.org/, 2006 colour matching functions */
double xyz_match[] = {  390,2.952420E-03,4.076779E-04,1.318752E-02,
                        395,7.641137E-03,1.078166E-03,3.424588E-02,
                        400,1.879338E-02,2.589775E-03,8.508254E-02,
                        405,4.204986E-02,5.474207E-03,1.927065E-01,
                        410,8.277331E-02,1.041303E-02,3.832822E-01,
                        415,1.395127E-01,1.712968E-02,6.568187E-01,
                        420,2.077647E-01,2.576133E-02,9.933444E-01,
                        425,2.688989E-01,3.529554E-02,1.308674E+00,
                        430,3.281798E-01,4.698226E-02,1.624940E+00,
                        435,3.693084E-01,6.047429E-02,1.867751E+00,
                        440,4.026189E-01,7.468288E-02,2.075946E+00,
                        445,4.042529E-01,8.820537E-02,2.132574E+00,
                        450,3.932139E-01,1.039030E-01,2.128264E+00,
                        455,3.482214E-01,1.195389E-01,1.946651E+00,
                        460,3.013112E-01,1.414586E-01,1.768440E+00,
                        465,2.534221E-01,1.701373E-01,1.582342E+00,
                        470,1.914176E-01,1.999859E-01,1.310576E+00,
                        475,1.283167E-01,2.312426E-01,1.010952E+00,
                        480,7.593120E-02,2.682271E-01,7.516389E-01,
                        485,3.836770E-02,3.109438E-01,5.549619E-01,
                        490,1.400745E-02,3.554018E-01,3.978114E-01,
                        495,3.446810E-03,4.148227E-01,2.905816E-01,
                        500,5.652072E-03,4.780482E-01,2.078158E-01,
                        505,1.561956E-02,5.491344E-01,1.394643E-01,
                        510,3.778185E-02,6.248296E-01,8.852389E-02,
                        515,7.538941E-02,7.012292E-01,5.824484E-02,
                        520,1.201511E-01,7.788199E-01,3.784916E-02,
                        525,1.756832E-01,8.376358E-01,2.431375E-02,
                        530,2.380254E-01,8.829552E-01,1.539505E-02,
                        535,3.046991E-01,9.233858E-01,9.753000E-03,
                        540,3.841856E-01,9.665325E-01,6.083223E-03,
                        545,4.633109E-01,9.886887E-01,3.769336E-03,
                        550,5.374170E-01,9.907500E-01,2.323578E-03,
                        555,6.230892E-01,9.997775E-01,1.426627E-03,
                        560,7.123849E-01,9.944304E-01,8.779264E-04,
                        565,8.016277E-01,9.848127E-01,5.408385E-04,
                        570,8.933408E-01,9.640545E-01,3.342429E-04,
                        575,9.721304E-01,9.286495E-01,2.076129E-04,
                        580,1.034327E+00,8.775360E-01,1.298230E-04,
                        585,1.106886E+00,8.370838E-01,8.183954E-05,
                        590,1.147304E+00,7.869950E-01,5.207245E-05,
                        595,1.160477E+00,7.272309E-01,3.347499E-05,
                        600,1.148163E+00,6.629035E-01,2.175998E-05,
                        605,1.113846E+00,5.970375E-01,1.431231E-05,
                        610,1.048485E+00,5.282296E-01,9.530130E-06,
                        615,9.617111E-01,4.601308E-01,6.426776E-06,
                        620,8.629581E-01,3.950755E-01,0.000000E+00,
                        625,7.603498E-01,3.351794E-01,0.000000E+00,
                        630,6.413984E-01,2.751807E-01,0.000000E+00,
                        635,5.290979E-01,2.219564E-01,0.000000E+00,
                        640,4.323126E-01,1.776882E-01,0.000000E+00,
                        645,3.496358E-01,1.410203E-01,0.000000E+00,
                        650,2.714900E-01,1.083996E-01,0.000000E+00,
                        655,2.056507E-01,8.137687E-02,0.000000E+00,
                        660,1.538163E-01,6.033976E-02,0.000000E+00,
                        665,1.136072E-01,4.425383E-02,0.000000E+00,
                        670,8.281010E-02,3.211852E-02,0.000000E+00,
                        675,5.954815E-02,2.302574E-02,0.000000E+00,
                        680,4.221473E-02,1.628841E-02,0.000000E+00,
                        685,2.948752E-02,1.136106E-02,0.000000E+00,
                        690,2.025590E-02,7.797457E-03,0.000000E+00,
                        695,1.410230E-02,5.425391E-03,0.000000E+00,
                        700,9.816228E-03,3.776140E-03,0.000000E+00,
                        705,6.809147E-03,2.619372E-03,0.000000E+00,
                        710,4.666298E-03,1.795595E-03,0.000000E+00,
                        715,3.194041E-03,1.229980E-03,0.000000E+00,
                        720,2.205568E-03,8.499903E-04,0.000000E+00,
                        725,1.524672E-03,5.881375E-04,0.000000E+00,
                        730,1.061495E-03,4.098928E-04,0.000000E+00,
                        735,7.400120E-04,2.860718E-04,0.000000E+00,
                        740,5.153113E-04,1.994949E-04,0.000000E+00,
                        745,3.631969E-04,1.408466E-04,0.000000E+00,
                        750,2.556624E-04,9.931439E-05,0.000000E+00,
                        755,1.809649E-04,7.041878E-05,0.000000E+00,
                        760,1.287394E-04,5.018934E-05,0.000000E+00,
                        765,9.172477E-05,3.582218E-05,0.000000E+00,
                        770,6.577532E-05,2.573083E-05,0.000000E+00,
                        775,4.708916E-05,1.845353E-05,0.000000E+00,
                        780,3.407653E-05,1.337946E-05,0.000000E+00,
                        785,2.469630E-05,9.715798E-06,0.000000E+00,
                        790,1.794555E-05,7.074424E-06,0.000000E+00,
                        795,1.306345E-05,5.160948E-06,0.000000E+00,
                        800,9.565993E-06,3.788729E-06,0.000000E+00,
                        805,7.037621E-06,2.794625E-06,0.000000E+00,
                        810,5.166853E-06,2.057152E-06,0.000000E+00,
                        815,3.815429E-06,1.523114E-06,0.000000E+00,
                        820,2.837980E-06,1.135758E-06,0.000000E+00,
                        825,2.113325E-06,8.476168E-07,0.000000E+00,
                        830,1.579199E-06,6.345380E-07,0.000000E+00  };

double lms_match[] = {  390,  4.07619E-04,  3.58227E-04,  6.14265E-03,
                        395,  1.06921E-03,  9.64828E-04,  1.59515E-02,
                        400,  2.54073E-03,  2.37208E-03,  3.96308E-02,
                        405,  5.31546E-03,  5.12316E-03,  8.97612E-02,
                        410,  9.98835E-03,  9.98841E-03,  1.78530E-01,
                        415,  1.60130E-02,  1.72596E-02,  3.05941E-01,
                        420,  2.33957E-02,  2.73163E-02,  4.62692E-01,
                        425,  3.09104E-02,  3.96928E-02,  6.09570E-01,
                        430,  3.97810E-02,  5.55384E-02,  7.56885E-01,
                        435,  4.94172E-02,  7.50299E-02,  8.69984E-01,
                        440,  5.94619E-02,  9.57612E-02,  9.66960E-01,
                        445,  6.86538E-02,  1.16220E-01,  9.93336E-01,
                        450,  7.95647E-02,  1.39493E-01,  9.91329E-01,
                        455,  9.07704E-02,  1.62006E-01,  9.06735E-01,
                        460,  1.06663E-01,  1.93202E-01,  8.23726E-01,
                        465,  1.28336E-01,  2.32275E-01,  7.37043E-01,
                        470,  1.51651E-01,  2.71441E-01,  6.10456E-01,
                        475,  1.77116E-01,  3.10372E-01,  4.70894E-01,
                        480,  2.07940E-01,  3.55066E-01,  3.50108E-01,
                        485,  2.44046E-01,  4.05688E-01,  2.58497E-01,
                        490,  2.82752E-01,  4.56137E-01,  1.85297E-01,
                        495,  3.34786E-01,  5.22970E-01,  1.35351E-01,
                        500,  3.91705E-01,  5.91003E-01,  9.67990E-02,
                        505,  4.56252E-01,  6.66404E-01,  6.49614E-02,
                        510,  5.26538E-01,  7.43612E-01,  4.12337E-02,
                        515,  5.99867E-01,  8.16808E-01,  2.71300E-02,
                        520,  6.75313E-01,  8.89214E-01,  1.76298E-02,
                        525,  7.37108E-01,  9.34977E-01,  1.13252E-02,
                        530,  7.88900E-01,  9.61962E-01,  7.17089E-03,
                        535,  8.37403E-01,  9.81481E-01,  4.54287E-03,
                        540,  8.90871E-01,  9.98931E-01,  2.83352E-03,
                        545,  9.26660E-01,  9.91383E-01,  1.75573E-03,
                        550,  9.44527E-01,  9.61876E-01,  1.08230E-03,
                        555,  9.70703E-01,  9.35829E-01,  6.64512E-04,
                        560,  9.85636E-01,  8.90949E-01,  4.08931E-04,
                        565,  9.96979E-01,  8.40969E-01,  2.51918E-04,
                        570,  9.99543E-01,  7.76526E-01,  1.55688E-04,
                        575,  9.87057E-01,  7.00013E-01,  9.67045E-05,
                        580,  9.57841E-01,  6.11728E-01,  6.04705E-05,
                        585,  9.39781E-01,  5.31825E-01,  3.81202E-05,
                        590,  9.06693E-01,  4.54142E-01,  2.42549E-05,
                        595,  8.59605E-01,  3.76527E-01,  1.55924E-05,
                        600,  8.03173E-01,  3.04378E-01,  1.01356E-05,
                        605,  7.40680E-01,  2.39837E-01,  6.66657E-06,
                        610,  6.68991E-01,  1.85104E-01,  4.43906E-06,
                        615,  5.93248E-01,  1.40431E-01,  2.99354E-06,
                        620,  5.17449E-01,  1.04573E-01,  0.000000000,
                        625,  4.45125E-01,  7.65841E-02,  0.000000000,
                        630,  3.69168E-01,  5.54990E-02,  0.000000000,
                        635,  3.00316E-01,  3.97097E-02,  0.000000000,
                        640,  2.42316E-01,  2.80314E-02,  0.000000000,
                        645,  1.93730E-01,  1.94366E-02,  0.000000000,
                        650,  1.49509E-01,  1.37660E-02,  0.000000000,
                        655,  1.12638E-01,  9.54315E-03,  0.000000000,
                        660,  8.38077E-02,  6.50455E-03,  0.000000000,
                        665,  6.16384E-02,  4.42794E-03,  0.000000000,
                        670,  4.48132E-02,  3.06050E-03,  0.000000000,
                        675,  3.21660E-02,  2.11596E-03,  0.000000000,
                        680,  2.27738E-02,  1.45798E-03,  0.000000000,
                        685,  1.58939E-02,  9.98424E-04,  0.000000000,
                        690,  1.09123E-02,  6.77653E-04,  0.000000000,
                        695,  7.59453E-03,  4.67870E-04,  0.000000000,
                        700,  5.28607E-03,  3.25278E-04,  0.000000000,
                        705,  3.66675E-03,  2.25641E-04,  0.000000000,
                        710,  2.51327E-03,  1.55286E-04,  0.000000000,
                        715,  1.72108E-03,  1.07388E-04,  0.000000000,
                        720,  1.18900E-03,  7.49453E-05,  0.000000000,
                        725,  8.22396E-04,  5.24748E-05,  0.000000000,
                        730,  5.72917E-04,  3.70443E-05,  0.000000000,
                        735,  3.99670E-04,  2.62088E-05,  0.000000000,
                        740,  2.78553E-04,  1.85965E-05,  0.000000000,
                        745,  1.96528E-04,  1.33965E-05,  0.000000000,
                        750,  1.38482E-04,  9.63397E-06,  0.000000000,
                        755,  9.81226E-05,  6.96522E-06,  0.000000000,
                        760,  6.98827E-05,  5.06711E-06,  0.000000000,
                        765,  4.98430E-05,  3.68617E-06,  0.000000000,
                        770,  3.57781E-05,  2.69504E-06,  0.000000000,
                        775,  2.56411E-05,  1.96864E-06,  0.000000000,
                        780,  1.85766E-05,  1.45518E-06,  0.000000000,
                        785,  1.34792E-05,  1.07784E-06,  0.000000000,
                        790,  9.80671E-06,  8.00606E-07,  0.000000000,
                        795,  7.14808E-06,  5.96195E-07,  0.000000000,
                        800,  5.24229E-06,  4.48030E-07,  0.000000000,
                        805,  3.86280E-06,  3.38387E-07,  0.000000000,
                        810,  2.84049E-06,  2.54942E-07,  0.000000000,
                        815,  2.10091E-06,  1.93105E-07,  0.000000000,
                        820,  1.56506E-06,  1.47054E-07,  0.000000000,
                        825,  1.16700E-06,  1.11751E-07,  0.000000000,
                        830,  8.73008E-07,  8.48902E-08,  0.000000000  };

/* Standard illuminant d65 values */
double standard_illuminant_values[] = { 300, 0.034100,301, 0.360140,302, 0.686180,303, 1.012220,304, 1.338260,305, 1.664300,306, 1.990340,307, 2.316380,308, 2.642420,309, 2.968460,310, 3.294500,311, 4.988650,312, 6.682800,313, 8.376950,314, 10.071100,315, 11.765200,316, 13.459400,317, 15.153500,318, 16.847700,319, 18.541800,320, 20.236000,321, 21.917700,322, 23.599500,323, 25.281200,324, 26.963000,325, 28.644700,326, 30.326500,327, 32.008200,328, 33.690000,329, 35.371700,330, 37.053500,331, 37.343000,332, 37.632600,333, 37.922100,334, 38.211600,335, 38.501100,336, 38.790700,337, 39.080200,338, 39.369700,339, 39.659300,340, 39.948800,341, 40.445100,342, 40.941400,343, 41.437700,344, 41.934000,345, 42.430200,346, 42.926500,347, 43.422800,348, 43.919100,349, 44.415400,350, 44.911700,351, 45.084400,352, 45.257000,353, 45.429700,354, 45.602300,355, 45.775000,356, 45.947700,357, 46.120300,358, 46.293000,359, 46.465600,360, 46.638300,361, 47.183400,362, 47.728500,363, 48.273500,364, 48.818600,365, 49.363700,366, 49.908800,367, 50.453900,368, 50.998900,369, 51.544000,370, 52.089100,371, 51.877700,372, 51.666400,373, 51.455000,374, 51.243700,375, 51.032300,376, 50.820900,377, 50.609600,378, 50.398200,379, 50.186900,380, 49.975500,381, 50.442800,382, 50.910000,383, 51.377300,384, 51.844600,385, 52.311800,386, 52.779100,387, 53.246400,388, 53.713700,389, 54.180900,390, 54.648200,391, 57.458900,392, 60.269500,393, 63.080200,394, 65.890900,395, 68.701500,396, 71.512200,397, 74.322900,398, 77.133600,399, 79.944200,400, 82.754900,401, 83.628000,402, 84.501100,403, 85.374200,404, 86.247300,405, 87.120400,406, 87.993600,407, 88.866700,408, 89.739800,409, 90.612900,410, 91.486000,411, 91.680600,412, 91.875200,413, 92.069700,414, 92.264300,415, 92.458900,416, 92.653500,417, 92.848100,418, 93.042600,419, 93.237200,420, 93.431800,421, 92.756800,422, 92.081900,423, 91.406900,424, 90.732000,425, 90.057000,426, 89.382100,427, 88.707100,428, 88.032200,429, 87.357200,430, 86.682300,431, 88.500600,432, 90.318800,433, 92.137100,434, 93.955400,435, 95.773600,436, 97.591900,437, 99.410200,438, 101.228000,439, 103.047000,440, 104.865000,441, 106.079000,442, 107.294000,443, 108.508000,444, 109.722000,445, 110.936000,446, 112.151000,447, 113.365000,448, 114.579000,449, 115.794000,450, 117.008000,451, 117.088000,452, 117.169000,453, 117.249000,454, 117.330000,455, 117.410000,456, 117.490000,457, 117.571000,458, 117.651000,459, 117.732000,460, 117.812000,461, 117.517000,462, 117.222000,463, 116.927000,464, 116.632000,465, 116.336000,466, 116.041000,467, 115.746000,468, 115.451000,469, 115.156000,470, 114.861000,471, 114.967000,472, 115.073000,473, 115.180000,474, 115.286000,475, 115.392000,476, 115.498000,477, 115.604000,478, 115.711000,479, 115.817000,480, 115.923000,481, 115.212000,482, 114.501000,483, 113.789000,484, 113.078000,485, 112.367000,486, 111.656000,487, 110.945000,488, 110.233000,489, 109.522000,490, 108.811000,491, 108.865000,492, 108.920000,493, 108.974000,494, 109.028000,495, 109.082000,496, 109.137000,497, 109.191000,498, 109.245000,499, 109.300000,500, 109.354000,501, 109.199000,502, 109.044000,503, 108.888000,504, 108.733000,505, 108.578000,506, 108.423000,507, 108.268000,508, 108.112000,509, 107.957000,510, 107.802000,511, 107.501000,512, 107.200000,513, 106.898000,514, 106.597000,515, 106.296000,516, 105.995000,517, 105.694000,518, 105.392000,519, 105.091000,520, 104.790000,521, 105.080000,522, 105.370000,523, 105.660000,524, 105.950000,525, 106.239000,526, 106.529000,527, 106.819000,528, 107.109000,529, 107.399000,530, 107.689000,531, 107.361000,532, 107.032000,533, 106.704000,534, 106.375000,535, 106.047000,536, 105.719000,537, 105.390000,538, 105.062000,539, 104.733000,540, 104.405000,541, 104.369000,542, 104.333000,543, 104.297000,544, 104.261000,545, 104.225000,546, 104.190000,547, 104.154000,548, 104.118000,549, 104.082000,550, 104.046000,551, 103.641000,552, 103.237000,553, 102.832000,554, 102.428000,555, 102.023000,556, 101.618000,557, 101.214000,558, 100.809000,559, 100.405000,560, 100.000000,561, 99.633400,562, 99.266800,563, 98.900300,564, 98.533700,565, 98.167100,566, 97.800500,567, 97.433900,568, 97.067400,569, 96.700800,570, 96.334200,571, 96.279600,572, 96.225000,573, 96.170300,574, 96.115700,575, 96.061100,576, 96.006500,577, 95.951900,578, 95.897200,579, 95.842600,580, 95.788000,581, 95.077800,582, 94.367500,583, 93.657300,584, 92.947000,585, 92.236800,586, 91.526600,587, 90.816300,588, 90.106100,589, 89.395800,590, 88.685600,591, 88.817700,592, 88.949700,593, 89.081800,594, 89.213800,595, 89.345900,596, 89.478000,597, 89.610000,598, 89.742100,599, 89.874100,600, 90.006200,601, 89.965500,602, 89.924800,603, 89.884100,604, 89.843400,605, 89.802600,606, 89.761900,607, 89.721200,608, 89.680500,609, 89.639800,610, 89.599100,611, 89.409100,612, 89.219000,613, 89.029000,614, 88.838900,615, 88.648900,616, 88.458900,617, 88.268800,618, 88.078800,619, 87.888700,620, 87.698700,621, 87.257700,622, 86.816700,623, 86.375700,624, 85.934700,625, 85.493600,626, 85.052600,627, 84.611600,628, 84.170600,629, 83.729600,630, 83.288600,631, 83.329700,632, 83.370700,633, 83.411800,634, 83.452800,635, 83.493900,636, 83.535000,637, 83.576000,638, 83.617100,639, 83.658100,640, 83.699200,641, 83.332000,642, 82.964700,643, 82.597500,644, 82.230200,645, 81.863000,646, 81.495800,647, 81.128500,648, 80.761300,649, 80.394000,650, 80.026800,651, 80.045600,652, 80.064400,653, 80.083100,654, 80.101900,655, 80.120700,656, 80.139500,657, 80.158300,658, 80.177000,659, 80.195800,660, 80.214600,661, 80.420900,662, 80.627200,663, 80.833600,664, 81.039900,665, 81.246200,666, 81.452500,667, 81.658800,668, 81.865200,669, 82.071500,670, 82.277800,671, 81.878400,672, 81.479100,673, 81.079700,674, 80.680400,675, 80.281000,676, 79.881600,677, 79.482300,678, 79.082900,679, 78.683600,680, 78.284200,681, 77.427900,682, 76.571600,683, 75.715300,684, 74.859000,685, 74.002700,686, 73.146500,687, 72.290200,688, 71.433900,689, 70.577600,690, 69.721300,691, 69.910100,692, 70.098900,693, 70.287600,694, 70.476400,695, 70.665200,696, 70.854000,697, 71.042800,698, 71.231500,699, 71.420300,700, 71.609100,701, 71.883100,702, 72.157100,703, 72.431100,704, 72.705100,705, 72.979000,706, 73.253000,707, 73.527000,708, 73.801000,709, 74.075000,710, 74.349000,711, 73.074500,712, 71.800000,713, 70.525500,714, 69.251000,715, 67.976500,716, 66.702000,717, 65.427500,718, 64.153000,719, 62.878500,720, 61.604000,721, 62.432200,722, 63.260300,723, 64.088500,724, 64.916600,725, 65.744800,726, 66.573000,727, 67.401100,728, 68.229300,729, 69.057400,730, 69.885600,731, 70.405700,732, 70.925900,733, 71.446000,734, 71.966200,735, 72.486300,736, 73.006400,737, 73.526600,738, 74.046700,739, 74.566900,740, 75.087000,741, 73.937600,742, 72.788100,743, 71.638700,744, 70.489300,745, 69.339800,746, 68.190400,747, 67.041000,748, 65.891600,749, 64.742100,750, 63.592700,751, 61.875200,752, 60.157800,753, 58.440300,754, 56.722900,755, 55.005400,756, 53.288000,757, 51.570500,758, 49.853100,759, 48.135600,760, 46.418200,761, 48.456900,762, 50.495600,763, 52.534400,764, 54.573100,765, 56.611800,766, 58.650500,767, 60.689200,768, 62.728000,769, 64.766700,770, 66.805400,771, 66.463100,772, 66.120900,773, 65.778600,774, 65.436400,775, 65.094100,776, 64.751800,777, 64.409600,778, 64.067300,779, 63.725100,780, 63.382800,781, 63.474900,782, 63.567000,783, 63.659200,784, 63.751300,785, 63.843400,786, 63.935500,787, 64.027600,788, 64.119800,789, 64.211900,790, 64.304000,791, 63.818800,792, 63.333600,793, 62.848400,794, 62.363200,795, 61.877900,796, 61.392700,797, 60.907500,798, 60.422300,799, 59.937100,800, 59.451900,801, 58.702600,802, 57.953300,803, 57.204000,804, 56.454700,805, 55.705400,806, 54.956200,807, 54.206900,808, 53.457600,809, 52.708300,810, 51.959000,811, 52.507200,812, 53.055300,813, 53.603500,814, 54.151600,815, 54.699800,816, 55.248000,817, 55.796100,818, 56.344300,819, 56.892400,820, 57.440600,821, 57.727800,822, 58.015000,823, 58.302200,824, 58.589400,825, 58.876500,826, 59.163700,827, 59.450900,828, 59.738100,829, 60.025300,830, 60.312500 };

long double get_blackbody_radiation(long double kelvin, long double wavelength)
{
    /* This may be inaccurate (extremely small values don't work well) */
    long double h = 6.62607004e-34l; /* Planck constant */
    long double k = 1.38064852e-23l; /* Boltzman constant */
    long double c = 299792458l; /* Speed of light */
    long double T = kelvin;
    wavelength /= 1000000000l; /* To metres instead of nm */
    long double lambda5 = powl(wavelength, 5.0l); /* Wavelength ^ 5 */
    return 1.0l / (lambda5 * (powl(M_E, (h*c)/(wavelength*k*T) - 1.0l)));
}

/* From 300 to 830 nm. */
double get_StandardIlluminant_factor(int wavelength)
{
    int i = 0;
    while (((int)standard_illuminant_values[i]) != wavelength) i += 2;
    return standard_illuminant_values[i+1] / get_blackbody_radiation(6504, wavelength);
}

/* Kelvin to XYZ. Method: calculate spectral distrbution of a standard illuminant (not pure blackbody) and match it to XYZ */
void kelvin_StandardIlluminant_to_XYZ(double temperature, double * XYZ_out)
{
    long double X = 0l, Y = 0l, Z = 0l;

    /* Calculate at 5nm intervals (as the colour match data is) */
    for (int w = 0; w < 88; ++w)
    {
        double wavelength = xyz_match[w*4];
        double radiation = get_blackbody_radiation(temperature, wavelength) * get_StandardIlluminant_factor(wavelength);
        X += radiation * xyz_match[w*4+1];
        Y += radiation * xyz_match[w*4+2];
        Z += radiation * xyz_match[w*4+3];
    }

    XYZ_out[0] = (double)(X/Y);
    XYZ_out[1] = (double)(Y/Y);
    XYZ_out[2] = (double)(Z/Y);
}

/* Kelvin to XYZ. Method: calculate spectral distrbution of a blackbody and match it to XYZ */
void kelvin_BlackBody_to_XYZ(double temperature, double * XYZ_out)
{
    long double X = 0l, Y = 0l, Z = 0l;

    /* Calculate at 5nm intervals (as the colour match data is) */
    for (int w = 0; w < 88; ++w)
    {
        double wavelength = xyz_match[w*4];
        double radiation = get_blackbody_radiation(temperature, wavelength);
        X += radiation * xyz_match[w*4+1];
        Y += radiation * xyz_match[w*4+2];
        Z += radiation * xyz_match[w*4+3];
    }

    XYZ_out[0] = (double)(X/Y);
    XYZ_out[1] = (double)(Y/Y);
    XYZ_out[2] = (double)(Z/Y);
}

/* Kelvin to LMS. Method: calculate spectral distrbution of a blackbody and match it to LMS */
void kelvin_BlackBody_to_LMS(double temperature, double * LMS_out)
{
    long double X = 0l, Y = 0l, Z = 0l;

    /* Calculate at 5nm intervals (as the colour match data is) */
    for (int w = 0; w < 88; ++w)
    {
        double wavelength = lms_match[w*4];
        double radiation = get_blackbody_radiation(temperature, wavelength);
        X += radiation * lms_match[w*4+1];
        Y += radiation * lms_match[w*4+2];
        Z += radiation * lms_match[w*4+3];
    }

    LMS_out[0] = (double)(X/Y);
    LMS_out[1] = (double)(Y/Y);
    LMS_out[2] = (double)(Z/Y);
}

/* Kelvin to LMS. Method: calculate spectral distrbution of a standard illuminant (not pure blackbody) and match it to LMS */
void kelvin_StandardIlluminant_to_LMS(double temperature, double * LMS_out)
{
    long double X = 0l, Y = 0l, Z = 0l;

    /* Calculate at 5nm intervals (as the colour match data is) */
    for (int w = 0; w < 88; ++w)
    {
        double wavelength = lms_match[w*4];
        double radiation = get_blackbody_radiation(temperature, wavelength) * get_StandardIlluminant_factor(wavelength);
        X += radiation * lms_match[w*4+1];
        Y += radiation * lms_match[w*4+2];
        Z += radiation * lms_match[w*4+3];
    }

    LMS_out[0] = (double)(X/Y);
    LMS_out[1] = (double)(Y/Y);
    LMS_out[2] = (double)(Z/Y);
}

/* Adds contrast(S-curve) to a value in a unique(or not) way */
double add_contrast ( double pixel, /* Range 0.0 - 1.0 */
                      double dark_contrast_range, 
                      double dark_contrast_factor, 
                      double light_contrast_range, 
                      double light_contrast_factor )
{
    /* Adjust based on the range, to make it not seem like range also controls strength */
    double dc_factor = dark_contrast_factor / (dark_contrast_range * 2);
    double lc_factor = light_contrast_factor / (light_contrast_range * 2);

    if (pixel < dark_contrast_range) 
        pixel = pow(pixel, 1 + (dark_contrast_range - pixel) 
        * (dc_factor
        /* Effect is reduced closer to end of range for a smooth curve: */
        * (1.0 - pixel/dark_contrast_range)) );

    pixel = 1.0 - pixel; /* Invert for contrasting the highlights */

    if (pixel < light_contrast_range && pixel > 0) 
        pixel = pow(pixel, 1 + (light_contrast_range - pixel) 
        * (lc_factor 
        * (1.0 - pixel/light_contrast_range)) );

    pixel = 1.0 - pixel; /* Invert back */

    return pixel;
}

void hsv_to_rgb(double hue, double saturation, double value, double * rgb)
{
    /* Red channel */
    if (hue < (120.0/360.0) && hue > (240.0/360.0))
    {
        if (hue < (60.0/360.0) || hue > (300.0/360.0))
        {
            rgb[0] = 1.0;
        }
        else
        {
            rgb[0] = hue;
            if (hue > (240.0/360.0)) rgb[0] = 1.0 - rgb[0];
            rgb[0] -= 60.0/360.0;
            rgb[0] *= 6.0;
        }
    }
    /* Green channel */
    if (hue < (240.0/360.0))
    {
        if (hue > (60.0/360.0) && hue < (180.0/360.0))
        {
            rgb[1] = 1.0;
        }
        else
        {
            rgb[1] = hue;
            if (rgb[1] > (180.0/360.0)) rgb[1] = (240.0/360.0) - rgb[1];
            rgb[1] *= 6.0;
        }
    }
    /* Blue channel */
    if (hue > (120.0/360.0))
    {
        if (hue > (180.0/360.0) && hue < (300.0/360.0))
        {
            rgb[2] = 1.0;
        }
        else
        {
            if (hue > (300.0/360.0)) rgb[2] = 1.0 - rgb[2];
            else rgb[2] = hue - (120.0/360.0);
            rgb[2] *= 6.0;
        }
    }

    /* Saturation + value */
    for (int i = 0; i < 3; ++i)
    {
        /* Desaturate */
        rgb[i] = rgb[i] * saturation + (1.0 - saturation);
        /* Value */
        rgb[i] *= value;
    }
}

static double array_average(double * array, int length)
{
    double average = 0.0;
    for (int i = 0; i < length; ++i)
    {
        average += array[i];
    }
    average /= (double)length;
    return average;
}

void colour_correct_3_way( double * rgb,
                           double h_hue, double h_sat,
                           double m_hue, double m_sat,
                           double s_hue, double s_sat )
{
    /* Not done :[ */
}

void processing_update_curves(processingObject_t * processing)
{
    /* For 3 way colour correction (highlights and shadows) */
    // double colour_highlights[3];
    // hsv_to_rgb(processing->highlight_hue, 1.0, 1.0 colour_highlights);

    // double lighten_pow = 0.6 - processing->lighten * 0.3;
    double lighten_pow = 1.0 - processing->lighten;

    /* Precalculate the contrast(curve) from 0 to 1 */
    for (int i = 0; i < 65536; ++i)
    {
        double pixel_value/*, pixel_rgb[3]*/;

        /* Pixel 0-1 */
        pixel_value = (double)i / (double)65535.0;

        /* Add contrast to pixel */
        pixel_value = add_contrast( pixel_value,
                                    processing->dark_contrast_range, 
                                    processing->dark_contrast_factor, 
                                    processing->light_contrast_range, 
                                    processing->light_contrast_factor );

        /* 'Lighten' */
        pixel_value = pow(pixel_value, lighten_pow);

        /* 3 way correction is not on right now */

        // /* Do 3-way colour correction */
        // pixel_rgb[0] = pixel_value;
        // pixel_rgb[1] = pixel_value;
        // pixel_rgb[2] = pixel_value;

        // /* Restore to original 0-65535 range */
        // pixel_rgb[0] *= 65535.0;
        // pixel_rgb[1] *= 65535.0;
        // pixel_rgb[2] *= 65535.0;

        pixel_value *= 65535.0;

        processing->pre_calc_curve_r[i] = (uint16_t)pixel_value;
        processing->pre_calc_curve_g[i] = (uint16_t)pixel_value;
        processing->pre_calc_curve_b[i] = (uint16_t)pixel_value;
    }
}

/* Calculates the final matrix (processing->main_matrix), and precalculates all the values;
 * Combines: exposure + white balance + camera specific adjustment all in one matrix! */
void processing_update_matrices(processingObject_t * processing)
{
    /* Temporary working matrix */
    double temp_matrix_a[9];
    double temp_matrix_b[9];
    double temp_matrix_c[9];

    /* (for shorter code) */
    int32_t*pm[9];for(int i=0;i<9;i++)pm[i]=processing->pre_calc_matrix[i];

    /* Create a camera to sRGB matrix in temp_matrix_a */
    // memcpy(temp_matrix_a, processing->cam_to_sRGB_matrix, 9 * sizeof(double));
    memcpy(temp_matrix_a, (double *)id_matrix, 9 * sizeof(double)); /* just nothjng for now */

    /* whitebalance */

    double rgb_to_xyz[9] = { 0.4124564  ,0.3575761 , 0.1804375,
                             0.2126729  ,0.7151522 , 0.0721750,
                             0.0193339 , 0.1191920  ,0.9503041 };


    double alexafilm_matrix[9] = { 0.806165 ,0.168534  ,0.025301,
                                   0.091228 , 0.765221 , 0.14355,
                                   0.092241, 0.251418,  0.656341 };

//    memcpy(temp_matrix_a, temp_matrix_b, 9 * sizeof(double));


    double k1[3] = {1,1,1};
    double k2[3] = {1,1,1};
    double wb[3] = {1,1,1}; /* WB Multipliers */

// #define USE_LMS

#ifdef USE_LMS
    /* Transfer to cone space with bradford/ciecam whatever its called matrix */
    multiplyMatrices(temp_matrix_a, (double *)ciecam02, temp_matrix_b);
    kelvin_StandardIlluminant_to_LMS(6504, k1);
    kelvin_StandardIlluminant_to_LMS(processing->kelvin, k2);
    for (int i = 0; i < 3; ++i) wb[i] = (k1[i]/k2[i]);

    /* The tint application method is not at all scientific */
    for (int i = 0; i < 3; ++i) temp_matrix_b[i] *= (wb[0]) + (processing->wb_tint / 19.0);
    for (int i = 3; i < 6; ++i) temp_matrix_b[i] *= (wb[1]) + (processing->wb_tint / (-17));
    for (int i = 6; i < 9; ++i) temp_matrix_b[i] *= (wb[2]) + (processing->wb_tint / 11.0);

    /* Convert back to XYZ space from cone space -> to temp_matrix_a */
    invertMatrix((double *)ciecam02, temp_matrix_c);
    multiplyMatrices(temp_matrix_b, temp_matrix_c, temp_matrix_a);
#else
    multiplyMatrices(temp_matrix_a, (double *)id_matrix, temp_matrix_b); /* (nothing) */
    // kelvin_StandardIlluminant_to_XYZ(6504, k1);
    // kelvin_StandardIlluminant_to_XYZ(processing->kelvin, k2);
    // kelvin_BlackBody_to_XYZ(6504, k1);
    // kelvin_BlackBody_to_XYZ(processing->kelvin, k2);
    get_kelvin_multipliers_rgb(6500, k2);
    get_kelvin_multipliers_rgb(processing->kelvin, k1);
    for (int i = 0; i < 3; ++i) wb[i] = (k1[i]/k2[i]);

    /* The tint application method is not at all scientific */
    for (int i = 0; i < 3; ++i) temp_matrix_b[i] *= (wb[0]) + (processing->wb_tint / 19.0);
    for (int i = 3; i < 6; ++i) temp_matrix_b[i] *= (wb[1]) + (processing->wb_tint / (-17));
    for (int i = 6; i < 9; ++i) temp_matrix_b[i] *= (wb[2]) + (processing->wb_tint / 11.0);
    multiplyMatrices(temp_matrix_b, (double *)id_matrix, temp_matrix_a); /* aka do nothing */
#endif

    double rgbmat[] = {
         3.2404542, -1.5371385, -0.4985314,
        -0.9692660,  1.8760108,  0.0415560,
         0.0556434, -0.2040259,  1.0572252
    };
    /* Multiply the currently XYZ matrix back to RGB in to final_matrix */
    multiplyMatrices( temp_matrix_a,
                      rgbmat,
                      processing->final_matrix );

    /* Exposure, done here if smaller than 0, or no tonemapping - else done at gamma function */
    if (processing->exposure_stops < 0.0 || !processing->tone_mapping)
    {
        double exposure_factor = pow(2.0, processing->exposure_stops);
        for (int i = 0; i < 9; ++i) processing->final_matrix[i] *= exposure_factor;
    }

    /* Precalculate 0-65535 */
    for (int i = 0; i < 9; ++i)
    {
        for (int j = 0; j < 65536; ++j)
        {
            pm[i][j] = (int32_t)((double)j * processing->final_matrix[i]);
        }
    }

    processing_update_highest_green(processing);
    /* Highest green value - pixels at this value will need to be reconstructed */
    processing->highest_green = processing->pre_calc_gamma[ LIMIT16(MAX(pm[3][65535],pm[3][0]) + MAX(pm[4][65535],pm[4][0]) + MAX(pm[5][65535],pm[5][0])) ];

    /* This is nice */
    printMatrix(processing->final_matrix);

    /* done? */
}

void processing_update_highest_green(processingObject_t * processing)
{
    /* Highest green value - pixels at this value will need to be reconstructed */
    processing->highest_green = processing->pre_calc_gamma[ LIMIT16( MAX(processing->pre_calc_matrix[3][65535],processing->pre_calc_matrix[3][0]) 
                                                                   + MAX(processing->pre_calc_matrix[4][65535],processing->pre_calc_matrix[4][0]) 
                                                                   + MAX(processing->pre_calc_matrix[5][65535],processing->pre_calc_matrix[5][0]) ) ];
}

/* Box blur */
void blur_image( uint16_t * __restrict in,
                 uint16_t * __restrict temp,
                 int width, int height, int radius,
                 int do_r, int do_g, int do_b, /* Which channels to blur or not */
                 int start_y, int end_y )
{
    /* Row length */
    int rl = width * 3;

    int radius_x = radius*3;
    int y_max = height + radius;
    int x_max = (width + radius);
    int x_lim = rl-3;

    int blur_diameter = radius*2+1;

    int channels[3] = {do_r, do_g, do_b};

    /* Offset - do twice on channel '1' and '2' (Cb and Cr) */
    int limit_x = (width-radius-1)*3;
    for (int offset =0; offset < 3; ++offset)
    {
        if (channels[offset]) /* if this channel was requested */
        {
            /* Horizontal blur */
            for (int y = 0; y < height; ++y) /* rows */
            {
                uint16_t * temp_row = temp + (y * rl)+offset; /* current row ouptut */
                uint16_t * row = in + (y * rl)+offset; /* current row */

                int sum = row[0] * blur_diameter;

                /* Split in to 3 parts to avoid MIN/MAX */
                for (int x = -radius_x; x < radius_x; x+=3)
                {
                    sum -= row[MAX(x-radius_x, 0)];
                    sum += row[x+radius_x+3];
                    temp_row[MAX(x, 0)] = sum / blur_diameter;
                }
                for (int x = radius_x; x < limit_x; x+=3)
                {
                    sum -= row[x-radius_x];
                    sum += row[x+radius_x+3];
                    temp_row[x] = sum / blur_diameter;
                }
                for (int x = limit_x; x < rl; x+=3)
                {
                    sum -= row[x-radius_x];
                    sum += row[MIN(x+radius_x+3, rl-3)];
                    temp_row[x] = sum / blur_diameter;
                }
            }

            /* Vertical blur */
            int limit_y = height-radius-1;
            for (int x = 0; x < width; ++x) /* columns */
            {
                uint16_t * temp_col = in + (x*3);
                uint16_t * col = temp + (x*3);

                int sum = temp[x*3+offset] * blur_diameter;

                for (int y = -radius; y < radius; ++y)
                {
                    sum -= col[MAX((y-radius), 0)*rl+offset];
                    sum += col[(y+radius+1)*rl+offset];
                    temp_col[MAX(y, 0)*rl+offset] = sum / blur_diameter;
                }
                {
                    uint16_t * minus = col + (offset);
                    uint16_t * plus = col + ((radius*2+1)*rl + offset);
                    uint16_t * temp = temp_col + (radius*rl + offset);
                    uint16_t * end = temp_col + (limit_y*rl + offset);
                    do {
                        sum -= *minus;
                        sum += *plus;
                        *temp = sum / blur_diameter;
                        minus += rl;
                        plus += rl;
                        temp += rl;
                    } while (temp < end);
                }
                for (int y = limit_y; y < height; ++y)
                {
                    sum -= col[(y-radius)*rl+offset];
                    sum += col[MIN((y+radius+1), height-1)*rl+offset];
                    temp_col[y*rl+offset] = sum / blur_diameter;
                }
            }
        }
    }
}

void convert_rgb_to_YCbCr(uint16_t * __restrict img, int32_t size, int32_t ** lut)
{
    int32_t ** ry = lut;
    uint16_t * end = img + size;

    for (uint16_t * pix = img; pix < end; pix += 3)
    {
        /* RGB to YCbCr */
        int32_t pix_Y  =         ry[0][pix[0]] + ry[1][pix[1]] + ry[2][pix[2]];
        int32_t pix_Cb = 32768 + ry[3][pix[0]] + ry[4][pix[1]] + (pix[2] >> 1);
        int32_t pix_Cr = 32768 + (pix[0] >> 1) + ry[5][pix[1]] + ry[6][pix[2]];

        pix[0] = LIMIT16(pix_Y);
        pix[1] = LIMIT16(pix_Cb);
        pix[2] = LIMIT16(pix_Cr);
    }
}

void convert_YCbCr_to_rgb(uint16_t * __restrict img, int32_t size, int32_t ** lut)
{
    int32_t ** yr = lut;
    uint16_t * end = img + size;

    for (uint16_t * pix = img; pix < end; pix += 3)
    {
        int32_t pix_R = pix[0]                 + yr[0][pix[2]];
        int32_t pix_G = pix[0] + yr[1][pix[1]] + yr[2][pix[2]];
        int32_t pix_B = pix[0] + yr[3][pix[1]];

        pix[0] = LIMIT16(pix_R);
        pix[1] = LIMIT16(pix_G);
        pix[2] = LIMIT16(pix_B);
    }
}
